---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { site } from "../../config/site";

const formAction = import.meta.env.PUBLIC_CONTACT_FORM_ACTION ?? "";
---

<BaseLayout title="Contatti" description="Scrivimi: ti rispondo con calma e, se ha senso, fissiamo una call conoscitiva.">
  <section class="section-pad py-14 sm:py-20">
    <header class="max-w-2xl">
      <h1 class="text-3xl sm:text-4xl font-semibold tracking-tight">Contatti</h1>
      <p class="mt-5 text-zinc-700">
        Raccontami a che punto siete: vi rispondo con calma e, se vi va, fissiamo una call conoscitiva.
        <span class="block mt-2 text-sm text-zinc-500">Prezzi e dettagli li spiego sempre in call, mai a listino sul sito.</span>
      </p>
    </header>

    <div class="mt-10 grid gap-10 lg:grid-cols-[1.2fr_0.8fr] lg:items-start">
      <!-- FORM -->
      <form
        id="contact-form"
        action={formAction || "/contatti/grazie"}
        method="POST"
        class="max-w-xl space-y-5"
      >
        <!-- Formspree helpers -->
        <input type="hidden" name="_subject" value="Nuova richiesta dal sito" />
        <input type="hidden" name="_replyto" value="" />

        <!-- Honeypot anti-spam (bot only) -->
        <div class="hidden" aria-hidden="true">
          <label>
            Non compilare questo campo:
            <input name="website" type="text" tabindex="-1" autocomplete="off" />
          </label>
        </div>

        <div>
          <label class="block text-sm font-medium text-zinc-900" for="name">Nome</label>
          <input
            id="name"
            name="name"
            type="text"
            autocomplete="name"
            required
            class="mt-2 w-full rounded-2xl border border-zinc-300 px-4 py-3 text-sm text-zinc-900 placeholder:text-zinc-400 focus:ring-2 focus:ring-zinc-900 focus:ring-offset-2"
            placeholder="Come vi chiamate?"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-zinc-900" for="email">Email</label>
          <input
            id="email"
            name="email"
            type="email"
            autocomplete="email"
            required
            class="mt-2 w-full rounded-2xl border border-zinc-300 px-4 py-3 text-sm text-zinc-900 placeholder:text-zinc-400 focus:ring-2 focus:ring-zinc-900 focus:ring-offset-2"
            placeholder="nome@email.com"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-zinc-900" for="message">Messaggio</label>
          <textarea
            id="message"
            name="message"
            rows="6"
            required
            class="mt-2 w-full rounded-2xl border border-zinc-300 px-4 py-3 text-sm text-zinc-900 placeholder:text-zinc-400 focus:ring-2 focus:ring-zinc-900 focus:ring-offset-2"
            placeholder="Data, location, numero invitati, cosa vi ha colpito del mio stile…"
          ></textarea>
          <p class="mt-2 text-xs text-zinc-500">
            Tip: se avete già una data e una location, scrivetemele subito.
          </p>
        </div>

        <button
          type="submit"
          class="inline-flex items-center justify-center rounded-full bg-zinc-900 px-6 py-3 text-sm font-medium text-white transition duration-200 hover:opacity-90"
        >
          Invia richiesta
        </button>

        {!formAction ? (
          <p class="text-xs text-amber-700">
            Nota: <code>PUBLIC_CONTACT_FORM_ACTION</code> non è impostata. Il form ora punta a <code>/contatti/grazie</code>.
          </p>
        ) : null}
      </form>

      <script type="module">
        const form = document.getElementById("contact-form");
        if (!form) {
          console.warn("contact-form not found");
        } else {
            form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const action = form.getAttribute("action");
            // Se manca l'action (env non impostata), fallback alla tua thanks
            if (!action || action.startsWith("/")) {
              window.location.href = "/contatti/grazie";
              return;
            }

            // Honeypot: se compilato, fingi successo (anti-bot)
            const hp = form.querySelector('input[name="website"]');
            if (hp && hp.value) {
              window.location.href = "/contatti/grazie";
              return;
            }

            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.dataset.originalText = submitBtn.textContent;
              submitBtn.textContent = "Invio…";
            }

            try {
              const formData = new FormData(form);

              const res = await fetch(action, {
                method: "POST",
                body: formData,
                headers: {
                  "Accept": "application/json"
                }
              });

              if (res.ok) {
                window.location.href = "/contatti/grazie";
                return;
              }

              // errore “soft”
              alert("Ops, qualcosa è andato storto. Riprova tra poco.");
            } catch (err) {
              alert("Errore di rete. Controlla la connessione e riprova.");
            } finally {
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = submitBtn.dataset.originalText || "Invia richiesta";
              }
            }
          });
        }
      </script>

      <!-- SIDE CTA -->
      <aside class="rounded-3xl border border-zinc-200 p-7 sm:p-8">
        <h2 class="text-lg font-medium tracking-tight text-zinc-900">Preferite una call?</h2>
        <p class="mt-3 text-sm text-zinc-700">
          Se vi è più comodo, potete anche prenotare direttamente: vi faccio qualche domanda e vi spiego come lavoro.
        </p>

        <div class="mt-6 flex flex-col gap-3">
          <a
            class="inline-flex items-center justify-center rounded-full bg-zinc-900 px-5 py-3 text-sm font-medium text-white transition duration-200 hover:opacity-90"
            href={site.cta.primaryHref}
          >
            {site.cta.primaryLabel}
          </a>
          <a
            class="inline-flex items-center justify-center rounded-full border border-zinc-300 px-5 py-3 text-sm font-medium text-zinc-900 transition duration-200 hover:bg-zinc-50"
            href={site.cta.secondaryHref}
          >
            {site.cta.secondaryLabel}
          </a>
        </div>
      </aside>
    </div>
  </section>
</BaseLayout>